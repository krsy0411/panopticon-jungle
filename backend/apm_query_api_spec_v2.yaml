openapi: 3.0.0
info:
  title: APM Query API v2
  version: 1.1.0
  description: |
    This version of the APM Query API expands on the initial design to include a
    service overview endpoint.  The API is built on Elasticsearch indices for logs
    and spans and provides search, trace retrieval, service metrics, endpoint
    metrics and trace search functionality.  The new `/services` endpoint
    enumerates all services with their aggregated metrics over a given time range.

servers:
  - url: http://localhost:3000

paths:
  ##############################################################################################################
  # Service overview
  ##############################################################################################################
  "/services":
    get:
      summary: Retrieve overview metrics for all services
      description: |
        Returns a list of services with aggregated metrics over the specified time range.  Each
        service summary includes the total request count, 95th percentile latency, and error rate.
        Optional query parameters allow filtering by environment and controlling sorting and limits.
      parameters:
        - name: from
          in: query
          description: Start time (inclusive) of the aggregation window.
          required: false
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          description: End time (exclusive) of the aggregation window.
          required: false
          schema:
            type: string
            format: date-time
        - name: environment
          in: query
          description: Deployment environment filter (e.g. `prod`, `stage`, `dev`).  When not provided, all environments are included.
          required: false
          schema:
            type: string
        - name: sort_by
          in: query
          description: |
            Field to sort the service list by.  Valid values are:
            * `request_count` – Sort services by descending request count.
            * `latency_p95_ms` – Sort by descending 95th percentile latency.
            * `error_rate` – Sort by descending error rate.
            Default is `request_count`.
          required: false
          schema:
            type: string
            enum: [request_count, latency_p95_ms, error_rate]
        - name: limit
          in: query
          description: Maximum number of services to return.  Default is 50.
          required: false
          schema:
            type: integer
            minimum: 1
        - name: name_filter
          in: query
          description: Optional substring to filter service names by (case‑insensitive).
          required: false
          schema:
            type: string
      responses:
        "200":
          description: Service overview metrics returned
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceOverviewResponse"

  ##############################################################################################################
  # Trace retrieval (unchanged from v1)
  ##############################################################################################################
  "/traces/{traceId}":
    get:
      summary: Retrieve a trace by its trace ID
      description: |
        Returns all spans and associated logs for the specified trace ID.  This endpoint allows clients to
        reconstruct the call graph of a request or transaction.  The `traceId` corresponds to the `trace_id`
        stored on span and log documents【629151000030751†L228-L233】.  Optionally the result set can be
        filtered by `environment` and/or limited to a specific service.
      parameters:
        - name: traceId
          in: path
          description: Unique identifier of the trace.
          required: true
          schema:
            type: string
        - name: environment
          in: query
          description: Deployment environment to filter by (e.g. `prod`, `stage`, `dev`).
          required: false
          schema:
            type: string
        - name: service
          in: query
          description: Optional service name filter.  When specified, only spans and logs belonging to this service are returned.
          required: false
          schema:
            type: string
      responses:
        "200":
          description: Trace found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TraceResponse"
        "404":
          description: Trace not found

  ##############################################################################################################
  # Service‑level aggregated metrics (unchanged from v1)
  ##############################################################################################################
  "/services/{serviceName}/metrics":
    get:
      summary: Retrieve aggregated metrics for a service
      description: |
        Returns a series of service‑level metrics derived from span data.  Supported metrics include
        total request counts (`http_requests_total`), latency percentiles (`latency_p95_ms`, `latency_p90_ms`,
        `latency_p50_ms`) and error rate (`error_rate`).  When the `metric` parameter is omitted, all supported
        metrics are returned.  The `serviceName` corresponds to the `service_name` field on stored events and
        is case‑insensitive【629151000030751†L150-L170】.
      parameters:
        - name: serviceName
          in: path
          description: Name of the service to aggregate metrics for.
          required: true
          schema:
            type: string
        - name: metric
          in: query
          description: |
            Metric to compute.  If omitted, all supported metrics are returned.  Supported values are:
            * `http_requests_total` – Number of server‑side spans (kind `SERVER`) per interval.
            * `latency_p95_ms` – 95th percentile of `duration_ms` over server‑side spans.
            * `latency_p90_ms` – 90th percentile of `duration_ms` over server‑side spans.
            * `latency_p50_ms` – 50th percentile (median) of `duration_ms` over server‑side spans.
            * `error_rate` – Ratio of spans with `status=ERROR` to total spans in the interval.
          required: false
          schema:
            type: string
            enum: [http_requests_total, latency_p95_ms, latency_p90_ms, latency_p50_ms, error_rate]
        - name: from
          in: query
          description: Start time of the time window (inclusive) in ISO 8601 format.
          required: false
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          description: End time of the time window (exclusive) in ISO 8601 format.
          required: false
          schema:
            type: string
            format: date-time
        - name: environment
          in: query
          description: Deployment environment filter (e.g. `prod`, `stage`, `dev`).
          required: false
          schema:
            type: string
        - name: interval
          in: query
          description: |
            Aggregation interval for bucketing points (e.g. `1m` for one minute,
            `5m` for five minutes).  Valid time units are `s`, `m`, `h`.  If omitted,
            the implementation chooses a sensible default based on the date range.
          required: false
          schema:
            type: string
      responses:
        "200":
          description: Aggregated metrics returned
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/MetricResponse"
                  - type: array
                    items:
                      $ref: "#/components/schemas/MetricResponse"

  ##############################################################################################################
  # Log search (unchanged from v1)
  ##############################################################################################################
  "/logs":
    get:
      summary: Search logs across services
      description: |
        Retrieves log events from the `logs-apm.*` data streams.  Clients can filter by service name,
        environment, log level, trace ID, span ID, and a time window.  Messages may be searched with
        a full‑text query, subject to the underlying Elasticsearch mapping (the `message` field is indexed
        as text).  Pagination is supported via `page` and `size` parameters.  All filters are optional;
        when omitted, logs from all services and environments within the date range are returned.
      parameters:
        - name: service_name
          in: query
          description: Filter by service name【629151000030751†L150-L170】.
          required: false
          schema:
            type: string
        - name: environment
          in: query
          description: Filter by deployment environment (e.g. `prod`, `stage`, `dev`).
          required: false
          schema:
            type: string
        - name: level
          in: query
          description: Filter by log level.  Allowed values are `DEBUG`, `INFO`, `WARN`, `ERROR`.
          required: false
          schema:
            type: string
            enum: [DEBUG, INFO, WARN, ERROR]
        - name: trace_id
          in: query
          description: Filter by trace ID (logs with this `trace_id`).
          required: false
          schema:
            type: string
        - name: span_id
          in: query
          description: Filter by span ID (logs associated with this `span_id`).
          required: false
          schema:
            type: string
        - name: message
          in: query
          description: Full‑text query to search within the `message` field.
          required: false
          schema:
            type: string
        - name: from
          in: query
          description: Start time (inclusive) of the search window.
          required: false
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          description: End time (exclusive) of the search window.
          required: false
          schema:
            type: string
            format: date-time
        - name: page
          in: query
          description: Page number for pagination (1‑based index).  Defaults to 1.
          required: false
          schema:
            type: integer
            minimum: 1
        - name: size
          in: query
          description: Number of log items to return per page.  Defaults to 50; maximum 1000.
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
        - name: sort
          in: query
          description: Sort order by timestamp: `asc` for ascending or `desc` for descending (default is `desc`).
          required: false
          schema:
            type: string
            enum: [asc, desc]
      responses:
        "200":
          description: Log search results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LogSearchResponse"

  ##############################################################################################################
  # Span search (unchanged from v1)
  ##############################################################################################################
  "/spans":
    get:
      summary: Search spans across services
      description: |
        Retrieves span events from the `traces-apm.*` data streams.  Clients can filter spans by
        service name, environment, span name, kind, status, duration range, trace ID, and parent span ID.
        Results can be paginated and sorted by duration or start time.  If no filters are specified,
        spans from all services and environments within the date range are returned.
      parameters:
        - name: service_name
          in: query
          description: Filter by service name【629151000030751†L150-L170】.
          required: false
          schema:
            type: string
        - name: environment
          in: query
          description: Filter by deployment environment (e.g. `prod`, `stage`, `dev`).
          required: false
          schema:
            type: string
        - name: name
          in: query
          description: Filter spans by their `name` (operation or endpoint name).  Exact match only.
          required: false
          schema:
            type: string
        - name: kind
          in: query
          description: Filter spans by kind.  Allowed values are `SERVER`, `CLIENT`, `INTERNAL`.
          required: false
          schema:
            type: string
            enum: [SERVER, CLIENT, INTERNAL]
        - name: status
          in: query
          description: Filter spans by status (`OK` or `ERROR`).
          required: false
          schema:
            type: string
            enum: [OK, ERROR]
        - name: min_duration_ms
          in: query
          description: Minimum span duration in milliseconds.
          required: false
          schema:
            type: number
            format: double
        - name: max_duration_ms
          in: query
          description: Maximum span duration in milliseconds.
          required: false
          schema:
            type: number
            format: double
        - name: trace_id
          in: query
          description: Filter spans by trace ID.
          required: false
          schema:
            type: string
        - name: parent_span_id
          in: query
          description: Filter spans by parent span ID.
          required: false
          schema:
            type: string
        - name: from
          in: query
          description: Start time (inclusive) of the search window.
          required: false
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          description: End time (exclusive) of the search window.
          required: false
          schema:
            type: string
            format: date-time
        - name: page
          in: query
          description: Page number for pagination (1‑based index).  Defaults to 1.
          required: false
          schema:
            type: integer
            minimum: 1
        - name: size
          in: query
          description: Number of span items to return per page.  Defaults to 50; maximum 1000.
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
        - name: sort
          in: query
          description: Sort order.  Use `duration_asc` or `duration_desc` to sort by duration, or
            `start_time_asc`/`start_time_desc` to sort by start time.  Default is `start_time_desc`.
          required: false
          schema:
            type: string
            enum: [duration_asc, duration_desc, start_time_asc, start_time_desc]
      responses:
        "200":
          description: Span search results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SpanSearchResponse"

  ##############################################################################################################
  # Endpoint metrics per service (unchanged from v1)
  ##############################################################################################################
  "/services/{serviceName}/endpoints":
    get:
      summary: Retrieve aggregated metrics for each endpoint of a service
      description: |
        Returns metrics aggregated by endpoint (span name or HTTP path) for the specified service.  This
        endpoint enables analysis of the most frequently called or slowest endpoints within a service.
        The implementation derives request counts, latency percentiles and error rates from server spans
        (kind `SERVER`).  Endpoints are sorted by the `sort_by` parameter and limited by `limit`.
      parameters:
        - name: serviceName
          in: path
          description: Name of the service to aggregate endpoints for.
          required: true
          schema:
            type: string
        - name: from
          in: query
          description: Start time (inclusive) of the aggregation window.
          required: false
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          description: End time (exclusive) of the aggregation window.
          required: false
          schema:
            type: string
            format: date-time
        - name: environment
          in: query
          description: Deployment environment filter (e.g. `prod`, `stage`, `dev`).
          required: false
          schema:
            type: string
        - name: metric
          in: query
          description: |
            Metric to sort and filter by.  Supported values are:
            * `request_count` – Total number of requests per endpoint.
            * `latency_p95_ms` – 95th percentile latency per endpoint.
            * `error_rate` – Error rate per endpoint.
            When omitted, all metrics are computed and endpoints are sorted by `request_count`.
          required: false
          schema:
            type: string
            enum: [request_count, latency_p95_ms, error_rate]
        - name: sort_by
          in: query
          description: |
            Field to sort the endpoints by.  Valid values mirror the `metric` parameter (`request_count`,
            `latency_p95_ms`, `error_rate`).  Default is `request_count`.
          required: false
          schema:
            type: string
            enum: [request_count, latency_p95_ms, error_rate]
        - name: limit
          in: query
          description: Maximum number of endpoints to return.  Default is 10.
          required: false
          schema:
            type: integer
            minimum: 1
        - name: name_filter
          in: query
          description: Optional substring to filter endpoint names by (case‑insensitive).
          required: false
          schema:
            type: string
      responses:
        "200":
          description: Endpoint metrics aggregated for the service
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EndpointMetricsResponse"

  ##############################################################################################################
  # Trace search per service (unchanged from v1)
  ##############################################################################################################
  "/services/{serviceName}/traces":
    get:
      summary: Search root traces for a service
      description: |
        Retrieves a list of root traces (top‑level server spans) for the specified service.  Clients can
        filter by status, duration range, and time window.  Results are paginated and can be sorted by
        duration or start time.  This endpoint enables discovery of slow or error traces within a service.
      parameters:
        - name: serviceName
          in: path
          description: Name of the service whose traces are being queried.
          required: true
          schema:
            type: string
        - name: status
          in: query
          description: Filter traces by status (`OK` or `ERROR`).
          required: false
          schema:
            type: string
            enum: [OK, ERROR]
        - name: min_duration_ms
          in: query
          description: Minimum trace duration in milliseconds (sum of durations of all spans in the trace).
          required: false
          schema:
            type: number
            format: double
        - name: max_duration_ms
          in: query
          description: Maximum trace duration in milliseconds.
          required: false
          schema:
            type: number
            format: double
        - name: from
          in: query
          description: Start time (inclusive) of the search window.
          required: false
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          description: End time (exclusive) of the search window.
          required: false
          schema:
            type: string
            format: date-time
        - name: environment
          in: query
          description: Deployment environment filter (e.g. `prod`, `stage`, `dev`).
          required: false
          schema:
            type: string
        - name: page
          in: query
          description: Page number for pagination (1‑based index).  Defaults to 1.
          required: false
          schema:
            type: integer
            minimum: 1
        - name: size
          in: query
          description: Number of trace summaries to return per page.  Defaults to 20; maximum 200.
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 200
        - name: sort
          in: query
          description: |
            Sort order.  Use `duration_desc` or `duration_asc` to sort by total trace duration, or
            `start_time_desc`/`start_time_asc` to sort by start time.  Default is `duration_desc`.
          required: false
          schema:
            type: string
            enum: [duration_desc, duration_asc, start_time_desc, start_time_asc]
      responses:
        "200":
          description: Trace search results for the service
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TraceSearchResponse"

components:
  schemas:
    ##########################################################################################################
    # Shared schemas from v1
    ##########################################################################################################
    SpanItem:
      type: object
      description: A span event representing a discrete operation in a trace.
      properties:
        timestamp:
          type: string
          format: date-time
        span_id:
          type: string
        parent_span_id:
          type: string
          nullable: true
        name:
          type: string
        kind:
          type: string
          enum: [SERVER, CLIENT, INTERNAL]
        duration_ms:
          type: number
          format: double
        status:
          type: string
          enum: [OK, ERROR]
        service_name:
          type: string
        environment:
          type: string
        http_method:
          type: string
          nullable: true
        http_path:
          type: string
          nullable: true
        http_status_code:
          type: integer
          nullable: true
        labels:
          type: object
          additionalProperties:
            oneOf:
              - type: string
              - type: number
              - type: boolean
        db_statement:
          type: string
          nullable: true
      required:
        - timestamp
        - span_id
        - name
        - kind
        - duration_ms
        - status
        - service_name
        - environment

    LogItem:
      type: object
      description: A log event capturing a discrete occurrence within a trace or service.
      properties:
        timestamp:
          type: string
          format: date-time
        level:
          type: string
          enum: [DEBUG, INFO, WARN, ERROR]
        message:
          type: string
        service_name:
          type: string
        span_id:
          type: string
          nullable: true
        trace_id:
          type: string
          nullable: true
        labels:
          type: object
          additionalProperties:
            oneOf:
              - type: string
              - type: number
              - type: boolean
      required:
        - timestamp
        - level
        - message
        - service_name

    TraceResponse:
      type: object
      description: Aggregated view of a trace including its spans and logs.
      properties:
        trace_id:
          type: string
        spans:
          type: array
          items:
            $ref: "#/components/schemas/SpanItem"
        logs:
          type: array
          items:
            $ref: "#/components/schemas/LogItem"
      required:
        - trace_id
        - spans
        - logs

    MetricPoint:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        value:
          type: number
        labels:
          type: object
          nullable: true
          additionalProperties:
            type: string
      required:
        - timestamp
        - value

    MetricResponse:
      type: object
      properties:
        metric_name:
          type: string
        service_name:
          type: string
        environment:
          type: string
        points:
          type: array
          items:
            $ref: "#/components/schemas/MetricPoint"
      required:
        - metric_name
        - service_name
        - environment
        - points

    LogSearchResponse:
      type: object
      properties:
        total:
          type: integer
        page:
          type: integer
        size:
          type: integer
        items:
          type: array
          items:
            $ref: "#/components/schemas/LogItem"
      required:
        - total
        - page
        - size
        - items

    SpanSearchResponse:
      type: object
      properties:
        total:
          type: integer
        page:
          type: integer
        size:
          type: integer
        items:
          type: array
          items:
            $ref: "#/components/schemas/SpanItem"
      required:
        - total
        - page
        - size
        - items

    EndpointMetrics:
      type: object
      properties:
        endpoint_name:
          type: string
        service_name:
          type: string
        environment:
          type: string
        request_count:
          type: number
        latency_p95_ms:
          type: number
        error_rate:
          type: number
        labels:
          type: object
          nullable: true
          additionalProperties:
            type: string
      required:
        - endpoint_name
        - service_name
        - environment
        - request_count
        - latency_p95_ms
        - error_rate

    EndpointMetricsResponse:
      type: object
      properties:
        service_name:
          type: string
        environment:
          type: string
        from:
          type: string
          format: date-time
          nullable: true
        to:
          type: string
          format: date-time
          nullable: true
        endpoints:
          type: array
          items:
            $ref: "#/components/schemas/EndpointMetrics"
      required:
        - service_name
        - environment
        - endpoints

    TraceSummary:
      type: object
      properties:
        trace_id:
          type: string
        root_span_name:
          type: string
        status:
          type: string
          enum: [OK, ERROR]
        duration_ms:
          type: number
          format: double
        start_time:
          type: string
          format: date-time
        service_name:
          type: string
        environment:
          type: string
        labels:
          type: object
          nullable: true
          additionalProperties:
            oneOf:
              - type: string
              - type: number
              - type: boolean
      required:
        - trace_id
        - root_span_name
        - status
        - duration_ms
        - start_time
        - service_name
        - environment

    TraceSearchResponse:
      type: object
      properties:
        total:
          type: integer
        page:
          type: integer
        size:
          type: integer
        traces:
          type: array
          items:
            $ref: "#/components/schemas/TraceSummary"
      required:
        - total
        - page
        - size
        - traces

    ##########################################################################################################
    # New schemas for v2
    ##########################################################################################################
    ServiceSummary:
      type: object
      description: Aggregate metrics for a single service.
      properties:
        service_name:
          type: string
        environment:
          type: string
        request_count:
          type: number
        latency_p95_ms:
          type: number
        error_rate:
          type: number
        labels:
          type: object
          nullable: true
          additionalProperties:
            type: string
      required:
        - service_name
        - environment
        - request_count
        - latency_p95_ms
        - error_rate

    ServiceOverviewResponse:
      type: object
      description: Collection of service summaries over a given time range.
      properties:
        from:
          type: string
          format: date-time
          nullable: true
        to:
          type: string
          format: date-time
          nullable: true
        environment:
          type: string
          nullable: true
        services:
          type: array
          items:
            $ref: "#/components/schemas/ServiceSummary"
      required:
        - services