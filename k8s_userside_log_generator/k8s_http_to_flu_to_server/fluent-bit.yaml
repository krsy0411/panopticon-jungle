apiVersion: v1
kind: ServiceAccount
metadata:
  name: fluent-bit
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: fluent-bit
rules:
  - apiGroups: [""]
    resources:
      - namespaces
      - pods
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: fluent-bit
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: fluent-bit
subjects:
  - kind: ServiceAccount
    name: fluent-bit
    namespace: default
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush        5
        Daemon       Off
        Log_Level    info

    [INPUT]
        Name              tail
        Path              /var/log/containers/*ingress-nginx-controller*.log
        Parser            docker
        Tag               kube.ingress.* 
        Refresh_Interval  5
        Mem_Buf_Limit     5MB

    [INPUT]
        Name              tail
        Path              /var/log/containers/*log-generator*.log
        Parser            docker
        Tag               kube.backend.*
        Refresh_Interval  5
        Mem_Buf_Limit     5MB

    # ingress에 source, type 추가
    [FILTER]
        Name    modify
        Match   kube.ingress.*
        Add     source ingress
        Add     log_type nginx
    # backend에 source, type 추가
    [FILTER]
        Name    modify
        Match   kube.backend.*
        Add     source backend
        Add     log_type application

    # 쿠버네티스 메타데이터
    # [FILTER]
    #     Name                kubernetes
    #     Match               kube.*
    #     Kube_URL            https://kubernetes.default.svc:443
    #     Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    #     Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
    #     Merge_Log           On
    #     Keep_Log            Off
    #     K8S-Logging.Parser  On

    # 그냥 필드별로 추가하는 데이터.
    # [FILTER]
    #     Name    modify
    #     Match   *
    #     Add     cluster kind-local
    #     Add     environment dev

    # 같은 쿠버네티스 환경에 띄운 테스트백엔드서버
    # [OUTPUT]
    #     Name              http
    #     Match             *
    #     Host              log-collector-service
    #     Port              3001
    #     URI               /logs
    #     Format            json
    #     tls               Off

    # 카프카 서버로 날리는 설정
    [OUTPUT]
        Name              kafka
        Match             *
        Brokers           172.21.100.253:9092
        Topics            logs
        Format            json

  # timestamp 하나 더 추가
  parsers.conf: |
    [PARSER]
        Name   docker
        Format json
        Time_Key time
        Time_Format %Y-%m-%dT%H:%M:%S.%L
        Time_Keep On
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluent-bit
spec:
  selector:
    matchLabels:
      app: fluent-bit
  template:
    metadata:
      labels:
        app: fluent-bit
    spec:
      serviceAccountName: fluent-bit
      tolerations: # ← 추가
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
        - key: node-role.kubernetes.io/master # 구버전 호환
          operator: Exists
          effect: NoSchedule
      containers:
        - name: fluent-bit
          image: fluent/fluent-bit:2.2
          volumeMounts:
            - name: varlog
              mountPath: /var/log
              readOnly: true
            - name: varlibdockercontainers
              mountPath: /var/lib/docker/containers
              readOnly: true
            - name: fluent-bit-config
              mountPath: /fluent-bit/etc/
      volumes:
        - name: varlog
          hostPath:
            path: /var/log
        - name: varlibdockercontainers
          hostPath:
            path: /var/lib/docker/containers
        - name: fluent-bit-config
          configMap:
            name: fluent-bit-config
