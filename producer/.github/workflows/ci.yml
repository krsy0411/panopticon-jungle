name: CI - Test & Lint

# 이 워크플로우는 PR이 `main` 브랜치로 열릴 때 (pull_request) 동작합니다.
# - 목적: 백엔드/프론트엔드의 포맷 검사, 린트, 빌드/테스트를 자동화하여 코드 품질을 보장합니다.
on:
  pull_request:
    branches: [main]

jobs:
  # --------------------
  # Test & Lint job
  # 코드에 대해 포맷 검사, 린트, 유닛 테스트(커버리지) 및 커버리지 업로드를 수행합니다.
  # GitHub Actions 상에서 Node 설치/캐시와 npm ci를 사용합니다.
  # --passWithNoTests 옵션을 사용해 테스트가 없는 경우에도 실패하지 않도록 처리합니다.
  # --------------------
  test-and-lint:
    name: Tests & Lint
    runs-on: ubuntu-latest

    steps:
      # 코드 체크아웃: 레포 전체를 가져옵니다.
      - name: Checkout code
        uses: actions/checkout@v4

      # Node.js 설정: 워크플로우에서 사용할 Node 버전을 고정하고 npm 캐시를 활성화합니다.
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          # package-lock.json이 변경될 때만 캐시 무효화가 됩니다.
          cache-dependency-path: './package-lock.json'

      # 의존성 설치: CI 환경에서는 안정성을 위해 `npm ci` 사용을 권장합니다.
      - name: Install dependencies
        run: npm ci

      # 코드 포맷 검사(Prettier): 코드 스타일 규칙을 준수하는지 검사합니다.
      - name: Check code formatting
        run: npm run format:check

      # 린트(ESLint): 자동 수정 가능한 문제는 --fix로 고치고, 나머지는 에러로 처리합니다.
      - name: Run linter
        run: npm run lint

      # 유닛 테스트
      # - jest를 커버리지 모드로 실행합니다.
      # - --passWithNoTests: 테스트가 하나도 없을 때 실패하지 않도록 허용합니다 (CI가 중단되는 것을 방지).
      - name: Run unit tests (tolerate no tests)
        id: run-tests
        # jest 실행 시 테스트가 없으면 실패하지 않도록 --passWithNoTests 사용
        run: npm run test -- --passWithNoTests
